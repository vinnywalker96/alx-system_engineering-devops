global
   maxconn 2048
   tune.ssl.default-dh-param 2048

defaults
   option forwardfor
   option http-server-close


frontend www-http
   bind 54.162.0.152:80
   reqadd X-Forwarded-Proto:\ http
   default_backend www-backend

frontend www-https
    bind 54.162.0.152:443 ssl crt /etc/haproxy/certs/vestec.tech.pem
    reqadd X-Forwarded-Proto:\ https
    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    # Use the challenge backend if the challenge is set
    use_backend letsencrypt-backend if letsencrypt-acl
    default_backend www-backend
    
backend www-backend
   # ssl_fc: Returns true when the front connection was made via an SSL/TLS transport
   redirect scheme https code 301 if !{ ssl_fc }
   server web-01 54.160.92.159:80 check
   server web-02 54.234.73.142:80 check

backend letsencrypt-backend
   # Lets encrypt backend server
   server letsencrypt 127.0.0.1:54321

