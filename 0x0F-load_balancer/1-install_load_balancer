#!/usr/bin/env bash
# configure haproxy load-balancing server
sudo apt-get install -y --no-install-recommends software-properties-common
sudo add-apt-repository -y ppa:vbernat/haproxy-2.7
sudo apt-get update -y
sudo apt-get install -y haproxy=2.7.*
ACTIVATION=\
"ENABLED=1"
sudo bash -c "echo -e '$ACTIVATION' > /etc/default/haproxy"
CONFIG=\
"defaults
    mode http
    timeout client 10s
    timeout connect 5s
    timeout server 10s
    timeout http-request 10s

frontend localnodes
    bind *:80
    default_backend nodes

backend nodes
    balance roundrobin
    server 105775-web-01 18.234.80.132:80 check
    server 105775-web-02 100.25.160.25:80 check
"
sudo bash -c "echo -e '$CONFIG' > /etc/haproxy/haproxy.cfg"
sudo service haproxy restart
